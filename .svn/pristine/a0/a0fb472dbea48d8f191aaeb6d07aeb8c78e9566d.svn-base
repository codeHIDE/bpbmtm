package com.bypay.action;

import java.awt.Image;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;

import javax.imageio.ImageIO;
import javax.inject.Inject;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.interceptor.TransactionAspectSupport;

import net.sf.json.JSONArray;
import net.sf.json.JSONObject;

import com.Ostermiller.util.MD5;
import com.bypay.common.BaseAction;
import com.bypay.dao.BankBehalfBranchDao;
import com.bypay.dao.MccCodeDao;
import com.bypay.dao.MerInfoUpdateDao;
import com.bypay.dao.MerManagerDao;
import com.bypay.dao.MerTractDao;
import com.bypay.dao.MerTransDao;
import com.bypay.dao.OrderInfoDao;
import com.bypay.dao.OrderStatictisDao;
import com.bypay.dao.ProcedureDao;
import com.bypay.dao.RegionCodeDao;
import com.bypay.dao.SubMerAuthInfoDao;
import com.bypay.dao.SubMerInfoDao;
import com.bypay.dao.SubMerRateDao;
import com.bypay.dao.SubMerTerminalDao;
import com.bypay.dao.SubMerTerminalInfoDao;
import com.bypay.dao.SubMerTransDao;
import com.bypay.dao.SysOpLogDao;
import com.bypay.dao.TractInfoDao;
import com.bypay.domain.BankBehalfBranch;
import com.bypay.domain.MccCode;
import com.bypay.domain.MerInfoUpdate;
import com.bypay.domain.MerManager;
import com.bypay.domain.MerTract;
import com.bypay.domain.MerTrans;
import com.bypay.domain.OrderInfo;
import com.bypay.domain.OrderStatictis;
import com.bypay.domain.RegionCode;
import com.bypay.domain.SubMerAuthInfo;
import com.bypay.domain.SubMerInfo;
import com.bypay.domain.SubMerRate;
import com.bypay.domain.SubMerTerminal;
import com.bypay.domain.SubMerTerminalInfo;
import com.bypay.domain.SubMerTrans;
import com.bypay.domain.SysManager;
import com.bypay.domain.SysOpLog;
import com.bypay.domain.TractInfo;
import com.bypay.service.RegionCodeService;
import com.bypay.service.SysManagerService;
import com.bypay.util.DateUtil;
import com.bypay.util.HFSendData;
import com.bypay.util.PageUtil;
import com.richerpay.core.model.CoreTransInfo;
import com.richerpay.dubbo.service.PayService;

@SuppressWarnings("unchecked")
public class SubMerInfoAction extends BaseAction {
	private Logger logger = LoggerFactory.getLogger(SubMerInfoAction.class);
	private static final long serialVersionUID = 1L;
	// /////////////////////////////////声明要用到的对象////////////////////////////////////////////////
	@Inject
	private BankBehalfBranchDao bankBehalfBranchDao;// 银行 Dao层对象
	@Inject
	private SysManagerService sysManagerService; // 系统管理员service层对象
	@Inject
	private SubMerTerminalDao subMerTerminalDao; // 子商户设备信息dao层对象
	@Inject
	private MerInfoUpdateDao merInfoUpdateDao;
	@Inject
	private TractInfoDao tractInfoDao; // 通道Dao层
	@Inject
	private SubMerRateDao subMerRateDao; // 子商户交易费率Dao层
	@Inject
	private SubMerTransDao subMerTransDao; // 子商户交易配置Dao
	@Inject
	private SubMerInfoDao subMerInfoDao; // 子商户Dao层对象
	@Inject
	private MerManagerDao merManagerDao; // 管理员Dao层对象
	@Inject
	private SysOpLogDao sysOpLogDao; // 系统管理员日志Dao层对象
	@Inject
	private MccCodeDao mccCodeDao; // 行业类别Dao层对象
	@Inject
	private RegionCodeDao regionCodeDao; // 业务类别Dao层对象
	@Inject
	private MerTransDao merTransDao; // 机构交易配置Dao
	@Inject
	private MerTractDao merTractDao; // 机构通道Dao
	@Inject
	private OrderInfoDao orderInfoDao; // 机构通道Dao
	@Inject
	private OrderStatictisDao orderStatictisDao; // 机构通道Dao
	@Inject
	private ProcedureDao procedureDao; // 机构通道Dao
	@Inject
	private SubMerTerminalInfoDao subMerTerminalInfoDao;

	@Inject
	private RegionCodeService regionCodeService;
	@Autowired
	private PayService payService;
	private Map param; // 用于存储按条件查询的条件
	private String id; // 用于传递查询指定子商务信息的id
	private String subMerList; // 用于查询所有的getResponse().getWriter()
	private String rateStatus;
	private MerTrans merTrans; // 机构交易配置
	private SubMerInfo subMerInfo; // 子商户实体类对象
	private SubMerRate subMerRate; // 子商户交易费率
	private SysManager sysManager; // 系统管理员 对象
	private String transHighestFee;
	private SubMerTrans subMerTrans; // 子商户交易配置表对象
	private RegionCode regionCode;
	private List<MccCode> mccCodeList; // 行业类别
	private List<TractInfo> tractInfoList; // 通道对象
	private List<RegionCode> regionCodeList; // 业务类别
	private SubMerTerminal subMerTerminal; // 子商户设备信息实体类对象
	private List<SubMerRate> subMerRateList; // 用于存储查询属于同一个子商户的交易费率
	private List<SubMerInfo> listSubMerInfo; // 用于存储查询所有的子商务信息集合
	private List<MerTract> merTractList;
	@Inject
	private SubMerAuthInfoDao subMerAuthInfoDao; // 实人认证Dao
	private List<SubMerTerminal> listSubMerTerminal;// 用于存储查询属于同一个子商户的所有子商户设备信息
	private List<BankBehalfBranch> bankBehalfBranchList;// 用于存储查询到的银行
	/** *分页开始** */
	private int page = 1;
	private int pageSize = 15;
	/** *读取图片路径** */
	ResourceBundle rb = ResourceBundle.getBundle("com/bypay/config/bmtmUtil",
			Locale.getDefault());
	private List imgUrlList;
	/** *上传图片的参数** */
	private String imgType;
	private List<File> file;
	private String imgRealPath;
	private String headImgFile; // 门头照
	private String hallImgFile; // 大厅照
	private String regNoImgFile; // 营业执照
	private String taxNoImgFile; // 税务登记证
	private String occNoImgFile; // 组织机构代码证
	private String idCardImgFile; // 身份证照片
	private String personImgFile; // 个人大头照
	private String otherImgFile1; // 其他1
	private String otherImgFile2; // 其他2
	private String cardImgFile; // 银行卡
	private String bankPermitImgFile; // 银行开户许可证
	private List<String> fileFileName;
	private List<String> fileContentType;

	// ///////////////////////////////// 执行操作方法
	// /////////////////////////////////////////////

	// 审批失败，清空相关信息，重新注册
	public void eavFailSubInfo() {
		try {
			if (null == subMerInfo) {
				this.renderText("fone");
				return;
			} else {
				SubMerTerminal smt = new SubMerTerminal();
				smt.setSubMerId(String.valueOf(subMerInfo.getSubMerId()));
				smt.setMerSysId(subMerInfo.getMerSysId());
				List<SubMerTerminal> subMerTerminals = subMerTerminalDao
						.selectSubMerTerminalAll(smt);
				// 清空商户的法人信息
				if (null != subMerTerminals && subMerTerminals.size() != 0) {
					subMerInfo.setRemark(subMerInfo.getRemark() + "|"
							+ subMerTerminals.get(0).getTsn());
				}
				// 清空商户的法人信息
				subMerInfoDao.updateLegalInfo(subMerInfo);

				// 设备信息，清楚商户号，登录账户号、密码
				SubMerTerminal subMerTerminal = new SubMerTerminal();
				subMerTerminal.setSubMerId(String.valueOf(subMerInfo
						.getSubMerId()));
				subMerTerminalDao.updateLoginInfoAndSubId(subMerTerminal);

				// 删除设备明细信息
				SubMerTerminalInfo subMerTerminalInfo = new SubMerTerminalInfo();
				subMerTerminalInfo.setSubMerId(String.valueOf(subMerInfo
						.getSubMerId()));
				subMerTerminalInfoDao.deleteTerminalInfo(subMerTerminalInfo);

				subMerInfo = subMerInfoDao.getSubMerInfoById(subMerInfo
						.getSubMerId());

				if ("101".equals(subMerInfo.getMerSysId())) { // 至尊宝短信
					log.info("********至尊宝发送短信");
					HFSendData.sendZhiZuBao(subMerInfo.getContactorPhone(),
							"【至尊宝】您注册的商户审核失败!失败原因:"
									+ subMerInfo.getRemark().split("[|]")[0]);
				} else if ("103".equals(subMerInfo.getMerSysId())) { // 酷支付短信
					log.info("********酷支付发送短信");
					HFSendData.sendKuZhiFu(subMerInfo.getContactorPhone(),
							"【酷支付】您注册的商户审核失败!失败原因:"
									+ subMerInfo.getRemark().split("[|]")[0]);
				}
				// HFSendData.sendData(subMerInfo.getContactorPhone(),
				// "您注册的商户审核失败!失败原因:"+subMerInfo.getRemark().split("[|]")[0]);

				this.renderText("success");
				return;
			}
		} catch (Exception e) {
			e.printStackTrace();
			TransactionAspectSupport.currentTransactionStatus()
					.setRollbackOnly();
			try {
				this.renderText("fone");
				return;
			} catch (IOException e1) {
				e1.printStackTrace();
			}
		}
	}

	// 调账
	public void addAccounts() {
		try {
			String subMerId = getRequest().getParameter("subMerId");
			String merAmt = getRequest().getParameter("merAmt");
			if (subMerId == null || subMerId.equals("")) {
				getResponse().getWriter().write("子商户号不能为空");
				return;
			}
			if (merAmt == null || merAmt.equals("") || merAmt.equals("0")) {
				getResponse().getWriter().write("调帐金额不能为空或者为0");
				return;
			}
			subMerInfo = subMerInfoDao.getSubMerInfoById(subMerId);
			if (subMerInfo == null) {
				getResponse().getWriter().write("无此商户");
				return;
			}
			String settleDate = DateUtil.getDate("yyyyMMdd");
			settleDate = "20141105";
			OrderInfo orderInfo = new OrderInfo();
			orderInfo.setSubMerId(subMerId);
			orderInfo.setSettleDate(settleDate);
			List<OrderInfo> orderInfoList = orderInfoDao
					.selectOrderInfoBySubMerId(orderInfo);
			if (orderInfoList == null || orderInfoList.size() == 0) {
				getResponse().getWriter().write("此商户今日无交易");
				return;
			}
			Iterator<OrderInfo> orderInfoIt = orderInfoList.iterator();
			Long merAmt1 = 0L;
			Double merAmt2 = Double.parseDouble(merAmt) * 100;
			while (orderInfoIt.hasNext()) {
				OrderInfo orderInfo1 = (OrderInfo) orderInfoIt.next();
				if (orderInfo1.getMerAmt() != null)
					merAmt1 += Long.parseLong(orderInfo1.getMerAmt());
			}
			System.out.println("此商户今日交易金额：" + merAmt1 / 100 + "元");
			if (merAmt1 < merAmt2) {
				getResponse().getWriter().write("此商户今日交易金额不足：" + merAmt + "元");
				return;
			}
			orderInfo = orderInfoList.get(0);
			OrderInfo orderInfo1 = new OrderInfo();
			orderInfo1.setBatchId("88888888");
			orderInfo1.setTerminalId(orderInfo.getTerminalId());
			orderInfo1.setSubMerId(subMerId);
			orderInfo1.setMerSysId(orderInfo.getMerSysId());
			orderInfo1.setAgentIdL1(orderInfo.getAgentIdL1());
			orderInfo1.setAgentIdL2(orderInfo.getAgentIdL2());
			orderInfo1.setTransMerId(orderInfo.getTransMerId());
			orderInfo1.setTransType("10");
			orderInfo1.setTerminalType(orderInfo.getTerminalType());
			orderInfo1.setBusType(orderInfo.getBusType());
			orderInfo1.setMerOrderId(DateUtil.getDate("yyyyMMddHHmmss"));
			orderInfo1.setMerOrderTime(DateUtil.getDate("yyyyMMddHHmmss"));
			orderInfo1.setMerAmt(merAmt2 + "");
			orderInfo1.setOrderFee("0");
			orderInfo1.setCurrency(orderInfo.getCurrency());
			orderInfo1.setOrderDesc("调账订单");
			orderInfo1.setOrderOverTime("");
			orderInfo1.setOrderStatus("1");
			orderInfo1.setRefundStatus("0");
			orderInfo1.setCreateTime(DateUtil.getDate("yyyy-MM-dd HH:mm:ss"));
			orderInfo1.setTransTime(DateUtil.getDate("yyyy-MM-dd HH:mm:ss"));
			orderInfo1.setFinshTime(DateUtil.getDate("yyyy-MM-dd HH:mm:ss"));
			orderInfo1.setBatchNo("888888");
			orderInfo1.setRefferNo("88888888");
			orderInfo1.setAuthNo("888888");
			orderInfo1.setVoucherNo("888888");
			orderInfo1.setSettleAmt(merAmt2 + "");
			orderInfo1.setSettleDate(DateUtil.getDate("yyyyMMdd"));
			orderInfo1.setTransFee("0");
			orderInfo1.setOrderRateType(orderInfo.getOrderRateType());
			orderInfo1.setRespDesc("调账成功");
			String orderId = procedureDao.getOrderId();
			orderInfo1.setOrderId(orderId);
			OrderStatictis orderStatictis = new OrderStatictis();
			orderStatictis.setOrderId(orderId);
			orderStatictis.setSubMerId(subMerId);
			orderStatictis.setMerAmt(merAmt2 + "");
			orderStatictis.setTransFee("0");
			orderStatictis.setClearAmt(merAmt2 + "");
			orderStatictis.setSettleDate(DateUtil.getDate("yyyyMMdd"));
			orderStatictis.setTransType("10");
			orderStatictis.setClearType("1");
			orderStatictis.setCreateTime(DateUtil.getDate("yyyyMMddHHmmss"));
			int i = orderInfoDao.insertOrderInfo(orderInfo1);
			if (i != 0) {
				i = orderStatictisDao.insertOrderStatictis(orderStatictis);
				if (i != 0) {
					getResponse().getWriter().write("调账成功");
				} else {
					getResponse().getWriter().write("调账失败");
				}
			} else {
				getResponse().getWriter().write("调账失败");
			}
		} catch (Exception e) {
			try {
				getResponse().getWriter().write("调账失败");
			} catch (IOException e1) {
				e1.printStackTrace();
			}
			e.printStackTrace();
		}
	}

	public void downloadImg() {
		FileInputStream fis = null;
		OutputStream out = null;
		try {
			subMerInfo = subMerInfoDao.getSubMerInfoById(id);
			String path = rb.getString("ImagesUrl") + "/SubMerImages/"
					+ subMerInfo.getMerSysId() + "/" + subMerInfo.getSubMerId()
					+ "/" + imgType + ".jpg";
			System.out.println(path);
			File file = new File(path);
			if (!file.exists()) {
				getRequest().setAttribute("mess", "FondImage");
				return;
			}
			HttpServletResponse response = getResponse();
			response.setContentType("image/jpeg");
			response.setHeader("Content-Disposition", "attachment; filename="
					+ file.getName());
			response.addHeader("Content-Length", file.length() + "");
			fis = new FileInputStream(file);
			out = response.getOutputStream();
			byte[] b = new byte[1024];
			int len = 0;
			while ((len = fis.read(b)) != -1) {
				out.write(b, 0, len);
			}
		} catch (Exception e) {
			e.printStackTrace();
		} finally {
			try {
				if (fis != null) {
					fis.close();
				}
				if (out != null)
					out.close();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		getRequest().setAttribute("mess", "Succ");
	}

	// 查询所有子商务信息，用于在页面显示
	public void findAll() {
		try {
			if (subMerInfo == null) {
				subMerInfo = new SubMerInfo();
				subMerTrans = new SubMerTrans();
			}
			if (subMerInfo.getSubMerName() != null) {
				System.out.println("转码前：SubMerName="
						+ subMerInfo.getSubMerName());
				// subMerInfo.setSubMerName(new
				// String(subMerInfo.getSubMerName().getBytes("ISO-8859-1"),
				// "UTF-8"));
				// System.out.println("转码后：SubMerName="+subMerInfo.getSubMerName());
			}
			Map map = PageUtil.getPageMap(page, pageSize);
			map.put("subMerInfo", subMerInfo);
			int count = subMerInfoDao.selectSubMerchantInfoCount(map);
			listSubMerInfo = subMerInfoDao.findAll(map);
			JSONArray array = JSONArray.fromObject(listSubMerInfo);
			JSONObject object = new JSONObject();
			object.put("Rows", array.toString());
			object.put("Total", count);
			subMerList = object.toString();
			getResponse().getWriter().write(subMerList);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}
	
	/**
	 * 代付验证
	 * @Title:        checkPay 
	 * @Description:  
	 * @param:            
	 * @return:       void    
	 * @throws 
	 * @author        Eason Jiang
	 * @Date          2015-7-1 下午5:19:57
	 */
	public void checkPay(){
		 String subMerId = this.getParameterForString("subMerId");
		 //卡号跟姓名 商户号
		 CoreTransInfo coreTransInfo = new CoreTransInfo();
    	 Boolean flag = Boolean.FALSE;
		 try{
			 SubMerInfo subMerInfo = subMerInfoDao.getSubMerInfoById(subMerId);
			 coreTransInfo.setPan(subMerInfo.getSettAccountNo());
	    	 coreTransInfo.setIdNumber(subMerInfo.getLegalIdcard().substring(subMerInfo.getLegalIdcard().length()-6));
	    	 coreTransInfo.setUserName(subMerInfo.getLegalPerson());		//姓名
	    	 coreTransInfo.setChTermId("01010611");		//终端号
	    	 coreTransInfo.setTerminalNo("01010611");
	    	 coreTransInfo.setChMerId("898220183980106");		//商户号
	    	 coreTransInfo.setMerId("898220183980106");
	    	 SimpleDateFormat sdf = new SimpleDateFormat("HHmmss");
	    	 coreTransInfo.setTrackingNo(sdf.format(new Date()));
	    	 coreTransInfo.setTransType("1001");		//银行卡
	    	 coreTransInfo.setTransSource("201");		//手刷
	    	 coreTransInfo.setMessageType("0200");		//消费
	    	 coreTransInfo.setProcessingCode("330000");
	    	 coreTransInfo.setBatchNo("000001");
	    	 coreTransInfo.setCurrencyCode("156");		//恒定156
	    	 logger.info("子商户代付验证make object suc coreTransInfo="+coreTransInfo.toString());
	    	 coreTransInfo = payService.doEntrustPayVerify(coreTransInfo);
	    	 logger.info("*******doPay resp："
						+ coreTransInfo.getResponseCode());
			 if(StringUtils.isNotEmpty(coreTransInfo.getResponseCode()) && coreTransInfo.getResponseCode().equals("00")){
				 flag = true;
				 //成功则更新状态
				 subMerInfoDao.updateCheckSub(subMerId);
			 }
			 getResponse().getWriter().write(flag.toString());
		 }catch(Exception e){
			 e.printStackTrace();
		 }
	}
	
	// 查询 指定子商务的信息，用于修改
	public String getById() {
		try {
			if (this.getSubMerInfo() == null)
				this.setSubMerInfo(new SubMerInfo());
			this.subMerInfo.setSubMerId(id);
			subMerInfo = this.getSubMerInfoDao().findById(subMerInfo);
			subMerTrans = new SubMerTrans();
			subMerTrans.setSubMerId(id);
			subMerTrans = subMerTransDao.selectSubMerTransById(subMerTrans);
			mccCodeList = mccCodeDao.selectMccCodeAll();
			param = new HashMap<String, Object>();
			param.put("page", null);
			param.put("pageSize", null);
			regionCodeList = regionCodeDao.selectRegionCodeList(param);
			subMerRate = new SubMerRate();
			subMerRate.setSubMerId(id);
			merTractList = merTractDao.selectmerTractByMerSysId(subMerInfo
					.getMerSysId());
			rateInformationOrType();
			if (subMerRateList.size() > 0)
				subMerRate = subMerRateList.get(0);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return "findById";
	}

	// 查询 指定子商务的信息
	public String getSubMerInfoById() {
		try {
			if (this.getSubMerInfo() == null)
				this.setSubMerInfo(new SubMerInfo());
			this.subMerInfo.setSubMerId(id);
			subMerInfo = this.getSubMerInfoDao().findById(subMerInfo);
			subMerTrans = new SubMerTrans();
			subMerTrans.setSubMerId(id);
			subMerTrans = subMerTransDao.selectSubMerTransById(subMerTrans);
			mccCodeList = mccCodeDao.selectMccCodeAll();
			param = new HashMap<String, Object>();
			param.put("page", null);
			param.put("pageSize", null);
			regionCodeList = regionCodeDao.selectRegionCodeList(param);
			subMerRate = new SubMerRate();
			subMerRate.setSubMerId(id);
			merTractList = merTractDao.selectmerTractByMerSysId(subMerInfo
					.getMerSysId());
			rateInformationOrType();
			if (subMerRateList.size() > 0)
				subMerRate = subMerRateList.get(0);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return "findSubMerInfoById";
	}

	// 当用户改变费率类型时触发改事件
	public void onchangeRateType() {
		try {
			subMerRateList = subMerRateDao
					.selectListSubMerRateGetById(subMerInfo.getSubMerRate());
			JSONArray object = JSONArray.fromObject(subMerRateList.get(0));
			getResponse().getWriter().write(object.toString());
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 修改 费率 前查询费率信息
	public String rateInformationOrType() {
		subMerRateList = subMerRateDao.selectListSubMerRateGetById(subMerRate);// 查询子商户的费率信息
		String subMerId = subMerRate.getSubMerId();
		subMerInfo = new SubMerInfo();
		subMerInfo.setSubMerId(subMerId);
		subMerInfo = subMerInfoDao.findById(subMerInfo);
		if ("type".equals(id))
			return "type";
		else
			return "information";
	}

	// 修改指定的子商户信息
	public void updateFindById() {
		try {
			if (subMerInfo != null) {
				subMerInfo.setRegion(subMerInfo.getRegion()
						+ subMerInfo.getCity());
				if (subMerInfoDao.update(subMerInfo)) {
					SubMerTrans merTrans = new SubMerTrans();
					merTrans.setSubMerId(subMerInfo.getSubMerTrans()
							.getSubMerId());
					merTrans.setDispMerId(subMerInfo.getSubMerTrans()
							.getDispMerId());
					merTrans.setDisMerName(subMerInfo.getSubMerTrans()
							.getDisMerName());
					int i = subMerTransDao.updateSubMerTransInfo(merTrans);
					if (i > 0) {
						getResponse().getWriter().write("2");
					}

				}
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 修改指定子商户的交易费率 类型
	public void updateSubMerchantInfoRateType() {
		try {
			JSONObject jF = null; // 封顶JSON
			JSONObject jK = null; // 扣率JSON
			MerInfoUpdate merInfoUpdate = new MerInfoUpdate(); // 初始化变更表
			merInfoUpdate.setMid(id); // 商户号
			merInfoUpdate.setMerType("1"); // 商户类型 1是子商户
			merInfoUpdate.setStatus("0"); // 变更状态 0：审请
			merInfoUpdate.setModifyType("03"); // 更新类型 01类型变更
			merInfoUpdate.setCreateTime(DateUtil.getDate("yyyy-MM-dd")); // 创建时间
			String feng = subMerInfo.getSubMerRate().getRateType(); // 提取封顶类型
			String kou = subMerRate.getRateType(); // 提取扣率类型
			SubMerRate smr1 = new SubMerRate();
			smr1.setSubMerId(id);
			subMerRateList = subMerRateDao.selectListSubMerRateGetById(smr1); // 查询子商户的费率信息
			for (SubMerRate smr : subMerRateList) {
				String smrTypt = smr.getRateType(); // 提取当前费率类型
				if (smrTypt.equals(feng) && !"1".equals(smr.getStatus())) {
					jF = JSONObject.fromObject(subMerInfo.getSubMerRate());
				}
				if (smrTypt.equals(kou) && !"1".equals(smr.getStatus())) {
					jK = JSONObject.fromObject(subMerRate);
				}
			}
			if (jF != null && jK != null)
				merInfoUpdate.setValue(jF.toString() + "|" + jK.toString()); // 变更数据值
			else if (jF != null)
				merInfoUpdate.setValue(jF.toString() + "|"); // 变更数据值
			else if (jK != null)
				merInfoUpdate.setValue(jK.toString() + "|"); // 变更数据值
			int num = merInfoUpdateDao.insertMerInfoUpdate(merInfoUpdate);
			if (num > 0)
				getResponse().getWriter().write("2");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 修改指定子商户的交易费率 信息
	public void updateSubMerchantInfoRate() {
		try {
			JSONObject jo = null;
			JSONObject jb = null;
			if (subMerInfo != null) {
				if (subMerInfo.getSubMerRate() != null) {
					subMerInfo.getSubMerRate().setSubMerId(id);
					jb = JSONObject.fromObject(subMerInfo.getSubMerRate());
				}
			}
			if (subMerRate != null) {
				subMerRate.setSubMerId(id);
				jo = JSONObject.fromObject(subMerRate);
			}
			if (jb.toString().equals(jo.toString())) {
				getResponse().getWriter().write("4");
				return;
			}
			int num = 0;
			num = subMerRateDao.updateSubMerRate(subMerRate);
			if (num > 0)
				getResponse().getWriter().write("2");
			// MerInfoUpdate merInfoUpdate=new MerInfoUpdate(); //初始化变更表
			// merInfoUpdate.setMid(id); //商户号
			// merInfoUpdate.setMerType("1"); //商户类型 1是子商户
			// merInfoUpdate.setStatus("0"); //变更状态 0：审请
			// merInfoUpdate.setModifyType("01"); //更新类型 01费率变更
			// merInfoUpdate.setCreateTime(DateUtil.getDate("yyyy-MM-dd"));
			// //创建时间
			// num=merInfoUpdateDao.insertMerInfoUpdate(merInfoUpdate);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 查询子商户的所有终端号
	public void selectSubMerTerminal() {
		try {
			System.out.println("1243:" + getRequest().getParameter("id"));
			this.subMerTerminal = new SubMerTerminal();
			this.subMerTerminal.setSubMerId(this.id);
			this.listSubMerTerminal = subMerTerminalDao
					.selectSubMerTerminalAll(subMerTerminal);
			JSONArray array = JSONArray.fromObject(listSubMerTerminal);
			JSONObject object = new JSONObject();
			object.put("Rows", array.toString());
			object.put("Total", listSubMerTerminal.size());
			subMerList = object.toString();
			getResponse().getWriter().write(subMerList);
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 重置终端信息密码
	public void updateTerminalpePass() {
		try {
			HttpServletResponse response = getResponse();
			PrintWriter printWriter = response.getWriter();
			if (this.subMerTerminalDao.updateTreminalPwd(MD5
					.getHashString("123456"), id)) {
				printWriter.write("succ");
				System.out.println("修改成功！");
			} else {
				printWriter.write("fones");
				System.out.println("修改失败！");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 重置终端信息状态
	public void updateTerminalStatus() {
		try {
			HttpServletResponse response = getResponse();
			PrintWriter printWriter = response.getWriter();
			if (this.subMerTerminalDao.updateTreminalStatus("0", id)) {
				printWriter.write("succ");
				System.out.println("修改成功！");
			} else {
				printWriter.write("fones");
				System.out.println("修改失败！");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 查询指定子商户的信息 用于详情显示
	public String subMerchantTop() {
		getById();
		// 查询机构的终端产品类型
		merTrans = subMerInfoDao.getMerTransOnTerminalType(subMerInfo
				.getMerSysId());
		// String[] terminalType=merTrans.getTerminalType().split("|");
		// System.out.println("机构终端产品类型："+terminalType[1]+"：：：：：：："+terminalType[3]);
		merTractList = merTractDao.selectmerTractByMerSysId(subMerInfo
				.getMerSysId());
		if (this.rateStatus == "1" || "1".equals(rateStatus)) {
			return "getByIdSelect1";
		}
		return "getByIdSelect";
	}

	// 暂停/恢复/上线/详情 子商户
	public void subMerDetail() {
		try {
			if (subMerInfo == null) {
				getResponse().getWriter().write("fone");
				return;
			}
			if (subMerTrans != null) {

				// 如果机构终端产品类型为08 POS,上线时将子商户的终端状态改为使用中的
				if ("2".equals(subMerInfo.getStatus())) {
					SubMerTerminal subMerTerminal = subMerTerminalDao
							.getSubMerTerminalTSN(subMerInfo.getSubMerId());
					if (null != subMerTerminal
							&& null != subMerTerminal.getCategory()
							&& !"".equals(subMerTerminal.getCategory())
							&& "08".equals(subMerTerminal.getCategory())) {
						// 修改子商户终端状态
						subMerTerminalDao.updateTreminalStatusBySubMerId("1",
								subMerInfo.getSubMerId());
					}
				}
			}

			if (subMerTrans != null) {
				subMerTrans.setSubMerId(subMerInfo.getSubMerId());
				if (!"-1".equals(subMerTrans.getSubMerTractR1())
						&& !"-1".equals(subMerTrans.getSubMerTractR2())
						&& !"-1".equals(subMerTrans.getSubMerTractR3()))
					subMerTransDao.updateSubMerTransInfo(subMerTrans);
			}
			boolean f = subMerInfoDao.updateStatus(subMerInfo);
			if (Integer.parseInt(subMerInfo.getStatus()) < 3)
				if (f) {
					// 添加子商户管理员
					MerManager merManager = new MerManager();
					merManager.setMid(subMerInfo.getSubMerId());
					int number = merManagerDao
							.selectMerManagerNameByMid(merManager);
					if (number == 0) {
						merManager.setMerType("1");
						merManager.setLoginName("admin");
						merManager.setLoginPwd(MD5.getHashString("admin"));
						merManager.setStatus("1");
						merManagerDao.insertMerManager(merManager);
					}

//					if ("101".equals(subMerInfo.getMerSysId())) { // 至尊宝短信
//						log.info("********至尊宝发送短信");
//						HFSendData.sendZhiZuBao(subMerInfo.getContactorPhone(),
//								"【至尊宝】您于" + DateUtil.getDate("yyyy-MM-dd")
//										+ ",商户" + subMerInfo.getSubMerName()
//										+ "上线成功!");
//					} else if ("103".equals(subMerInfo.getMerSysId())) { // 酷支付短信
//						log.info("********酷支付发送短信");
//						HFSendData.sendKuZhiFu(subMerInfo.getContactorPhone(),
//								"【酷支付】您于" + DateUtil.getDate("yyyy-MM-dd")
//										+ ",商户" + subMerInfo.getSubMerName()
//										+ "上线成功!");
//					}
					getResponse().getWriter().write("succ");
				} else {
//					if ("101".equals(subMerInfo.getMerSysId())) { // 至尊宝短信
//						log.info("********至尊宝发送短信");
//						HFSendData.sendZhiZuBao(subMerInfo.getContactorPhone(),
//								"【至尊宝】您于" + DateUtil.getDate("yyyy-MM-dd")
//										+ ",商户" + subMerInfo.getSubMerName()
//										+ "上线失败!");
//					} else if ("103".equals(subMerInfo.getMerSysId())) { // 酷支付短信
//						log.info("********酷支付发送短信");
//						HFSendData.sendKuZhiFu(subMerInfo.getContactorPhone(),
//								"【酷支付】您于" + DateUtil.getDate("yyyy-MM-dd")
//										+ ",商户" + subMerInfo.getSubMerName()
//										+ "上线失败!");
//					}
					getResponse().getWriter().write("fone");
					// HFSendData.sendData(subMerInfo.getContactorPhone(),
					// "您于"+DateUtil.getDate("yyyy-MM-dd")+",商户"+subMerInfo.getSubMerName()+"上线失败!");
				}
			if (subMerInfo.getStatus().equals("3"))
				if (f) {
					getResponse().getWriter().write("succSuspended");
				} else {
					getResponse().getWriter().write("fonesSuspended");
				}
			if (subMerInfo.getStatus().equals("5"))
				if (f) {
					getResponse().getWriter().write("succ");
				}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 验证密码的页面跳转方法
	public String passCheck() {
		return "checkPass";
	}

	// 点击修改结算信息前进行密码验证
	public void selectSubMerInfoPass() {
		try {
			if (sysManager != null) {
				sysManager.setLevelPwd(MD5.getHashString(sysManager
						.getLevelPwd()));
				SysManager sm = sysManagerService.getSysManager(sysManager);
				SysOpLog sysOpLog = new SysOpLog();
				if (sm != null) {
					getResponse().getWriter().write("succ");
					sysOpLog.setOpDesc("成功");
				} else {
					getResponse().getWriter().write("fone");
					sysOpLog.setOpDesc("失败");
				}
				sysOpLog.setLoginName(sysManager.getLoginName()); // 登录名
				sysOpLog.setOpTime(DateUtil.getDate("yyyy-MM-dd HH:mm:ss"));// 操作时间
				sysOpLog.setOpUrl("subMerInfo!selectSubMerInfoPass.ac"); // 路径
				sysOpLogDao.insertSysOpLog(sysOpLog);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 查询详情 用于修改结算信息
	public String selectUpdateSettSubMerchant() {
		try {
			selectSubMerInfoPass();
			if (subMerInfo == null) {
				subMerInfo = new SubMerInfo();
			}
			subMerInfo.setSubMerId(id);
			subMerInfo = subMerInfoDao.findById(subMerInfo);
			subMerTrans = new SubMerTrans();
			subMerTrans.setSubMerId(id);
			subMerTrans = subMerTransDao.selectSubMerTransById(subMerTrans);
			bankBehalfBranchList = bankBehalfBranchDao
					.selectBankBehalfBranchList();
			regionCodeList = regionCodeService
					.selectRegionCodeList2(regionCode);
		} catch (Exception e) {
			e.printStackTrace();
		}
		return "selectUpdateSettSubMerchant";
	}

	public void updatet0Status() {
		try {
			if (subMerTrans == null) {
				getResponse().getWriter().write("fone");
				return;
			}
			int i = subMerTransDao.updateSubMerTransInfo(subMerTrans);
			if (i != 1) {
				getResponse().getWriter().write("fone");
			} else {
				getResponse().getWriter().write("succ");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 修改结算信息
	public void updateSettSubMerchantInfo() {
		try {
			if (subMerInfo == null) {
				getResponse().getWriter().write("fone");
				return;
			}
			subMerInfo.setBillCycle(subMerInfo.getBillCycle().replace(" ", ""));
			String openBank = subMerInfo.getOpenBank();
			String region = subMerInfo.getRegion();
			String[] regions = region.split(",");
			String[] openBanks = openBank.split(",");
			openBank = openBanks[1];
			String lineNum = openBanks[0];
			String settAgency = subMerInfo.getSettAgency();

			subMerInfo.setRegion(regions[0].trim() + regions[2].trim());
			subMerInfo.setSettAgency(settAgency.split(",")[0]);
			subMerInfo.setOpenBank(openBank);
			subMerInfo.setLineNum(lineNum);
			if (subMerInfoDao.update(subMerInfo))
				getResponse().getWriter().write("success");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * 根据省份编号，查询出地域编号
	 */
	public void getRegionCodeListBySuperCode() {
		getResponse().setCharacterEncoding("UTF-8");
		try {
			log.info("根据省份信息获取城市信息");
			regionCodeList = regionCodeService
					.selectRegionCodeList2(regionCode);
			JSONArray jsonArray = JSONArray.fromObject(regionCodeList);
			System.out.println(jsonArray);
			getResponse().getWriter().write(jsonArray.toString());
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * 获取开户行信息
	 */
	public void getOpenBank() {
		log.info("获取开户行信息");
		try {
			List<SubMerInfo> openBankMap = subMerInfoDao
					.findLineNum(subMerInfo);
			JSONArray jsonArray = JSONArray.fromObject(openBankMap);
			System.out.println(jsonArray.toString());
			getResponse().getWriter().write(jsonArray.toString());
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 手动认证
	public void manual() {
		System.out.println("设置手动认证");
		try {
			if (id == null) {
				System.out.println("设置手动认证失败：" + id);
				getResponse().getWriter().write("N");
			} else {
				SubMerAuthInfo smai = new SubMerAuthInfo();
				smai.setSubMerId(id);
				smai.setAuthStatus("2");
				subMerAuthInfoDao.updateSubMerAuthInfoByStatus(smai);
				subMerTrans = new SubMerTrans();
				subMerTrans.setSubMerId(id);
				subMerTrans.setAuthStatus("2");
				SimpleDateFormat df = new SimpleDateFormat(
						"yyyy-MM-dd HH:mm:ss");// 设置日期格式
				subMerTrans.setAuthTime(df.format(new Date()));
				subMerTransDao.updateSubMerTransInfo(subMerTrans);
				getResponse().getWriter().write("Y");
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
	}

	// 查询子商户LOGO
	public String selectSubMerchantPicture() {
		System.out.println("获得子商户图片");
		subMerInfo = subMerInfoDao.findById(subMerInfo);
		String url = "";
		if (subMerInfo != null) {
			url = "/SubMerImages/" + subMerInfo.getMerSysId() + "/"
					+ subMerInfo.getSubMerId();
		}
		System.out.println("执行次数：" + id + "；子商户ID：" + subMerInfo.getSubMerId());
		getAllFileName("0", url);
		return "logoLook";
	}

	// 获得子商户图片
	public void getAllFileName(String count, String url) {
		String uploadPath = rb.getString("ImagesUrl") + url;
		imgUrlList = new ArrayList<String[]>();
		try {
			System.out.println("读取图片路经：" + uploadPath);
			File root = new File(uploadPath);
			if (root.exists() && root.isDirectory()) {
				File files[] = root.listFiles();
				if (files != null) {
					for (int i = 0; i < files.length; i++) {
						if (files[i].getName() != null
								&& !"".equals(files[i].getName())
								&& files[i].getName().indexOf(".") != -1
								&& files[i].getName().indexOf("orderSign") == -1) {
							String[] img = new String[6]; // 存储图片信息
							// 得到图片的标题 3:标题 4:操作
							int imgTypeTop = files[i].getName().indexOf(".");
							System.out.println(files[i].getName().substring(0,
									imgTypeTop));
							String imgTitle = files[i].getName().substring(0,
									imgTypeTop);
							System.out.println(imgTitle);
							// 获取图片信息。
							BufferedImage sourceImg = ImageIO
									.read(new FileInputStream(uploadPath + "/"
											+ files[i].getName()));
							img[0] = uploadPath + "/" + files[i].getName(); // 图片路径
							img[1] = sourceImg.getWidth() + ""; // 页面显示图片宽度
							img[2] = sourceImg.getHeight() + ""; // 页面显示图片高度
							// 如果是查看所有图片则缩小图片分辨率
							System.out.println("缩小图片分辨率，开始！！");
							Image imageIO = ImageIO.read(new File(uploadPath
									+ "/" + files[i].getName()));
							// 图片路径
							img[0] = uploadPath + "/minImg/" + imgTitle
									+ files[i].getName();
							sourceImg = new BufferedImage(48, 64,
									BufferedImage.TYPE_INT_RGB);
							img[1] = "48"; // 图片宽度
							img[2] = "64"; // 图片高度
							sourceImg.getGraphics().drawImage(
									imageIO.getScaledInstance(Integer
											.parseInt(img[1]), Integer
											.parseInt(img[2]),
											Image.SCALE_SMOOTH), 0, 0, null);
							File f = new File(uploadPath + "/minImg/");
							if (!f.exists()) {
								f.mkdirs();
							}
							// 如果之前没有缩小分辨率的图片则保存缩小后的图片
							ImageIO.write(sourceImg, "jpg", new File(uploadPath
									+ "/minImg/" + imgTitle
									+ files[i].getName()));
							imageIO.flush();
							sourceImg.flush();
							// 根据图片名进行图片信息匹配。存入数组
							if ("headImg".equals(imgTitle)) {
								img[3] = "门头照";
								img[4] = "none;";
								img[5] = "headImg";
							} else if ("hall".equals(imgTitle)) {
								img[3] = "大厅照";
								img[4] = "none;";
								img[5] = "hall";
							} else if ("regNo".equals(imgTitle)) {
								img[3] = "营业执照";
								img[4] = "none;";
								img[5] = "regNo";
							} else if ("taxNo".equals(imgTitle)) {
								img[3] = "税务登记证";
								img[4] = "none;";
								img[5] = "taxNo";
							} else if ("occNo".equals(imgTitle)) {
								img[3] = "组织机构代码证";
								img[4] = "none;";
								img[5] = "occNo";
							} else if ("idCard".equals(imgTitle)) {
								img[3] = "身份证照片";
								img[4] = "none;";
								img[5] = "idCard";
							} else if ("idCardBack".equals(imgTitle)) {
								img[3] = "身份证照片反面";
								img[4] = "none;";
								img[5] = "idCardBack";
							} else if ("person".equals(imgTitle)) {
								img[3] = "本人手持身份证照";
								img[4] = "inline;";
								img[5] = "person";
							} else if ("other1".equals(imgTitle)) {
								img[3] = "其他1";
								img[4] = "none;";
								img[5] = "other1";
							} else if ("other2".equals(imgTitle)) {
								img[3] = "其他2";
								img[4] = "none;";
								img[5] = "other2";
							} else if ("bankPermit".equals(imgTitle)) {
								img[3] = "银行开户许可证";
								img[4] = "none;";
								img[5] = "bankPermit";
							} else if ("card".equals(imgTitle)) {
								img[3] = "银行卡";
								img[4] = "none;";
								img[5] = "card";
							} else if ("cardBack".equals(imgTitle)) {
								img[3] = "银行卡反面";
								img[4] = "none;";
								img[5] = "cardBack";
							}  else {
								img[3] = "未命名";
								img[4] = "none;";
								img[5] = "1111";
							}
							// 如果当前图片为个人大头照则将图片信息存入第一位
							if (img[4].equals("inline;")) {
								if (imgUrlList.size() > 0) {
									String[] ss = (String[]) imgUrlList.get(0);
									imgUrlList.set(0, img);
									imgUrlList.add(ss);
								} else
									imgUrlList.add(img);
							} else
								imgUrlList.add(img);
							// 控制台输出图片信息
							System.out.println("url:" + img[0] + ";\n width:"
									+ img[1] + ";\n height:" + img[2]
									+ ";\n title:" + img[3] + ";\n 操作："
									+ img[4]);
						}
					}
				}
			}

		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	// 获得子商户图片用
	public String getImgIO() {
		try {
			FileInputStream is = new FileInputStream(imgRealPath);
			int i = is.available(); // 得到文件大小
			byte data[] = new byte[i];
			is.read(data); // 读数据
			is.close();
			getResponse().setContentType("image/*"); // 设置返回的文件类型
			OutputStream toClient = getResponse().getOutputStream(); // 得到向客户端输出二进制数据的对象
			toClient.write(data); // 输出数据
			toClient.close();
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}

	public void getMaxImgageUrl() {
		try {
			if (imgRealPath.indexOf("/minImg/") > 0) {
				// /usr\local\New_ProjectFiles\New_acqPosPlatform\SubMerImages
				// \27321323503\173665683924960\
				String url = imgRealPath.substring(0, imgRealPath
						.indexOf("/minImg/"));
				// regNoregNo.png
				String ss = imgRealPath.substring(imgRealPath
						.indexOf("/minImg/") + 8);
				// .jpg
				String type = ss.substring(ss.indexOf("."), ss.length());
				// regNo
				ss = ss.substring(0, ss.indexOf(".") / 2);
				System.out.println("图片名：" + ss + type);
				imgRealPath = url + "/" + ss + type;
				BufferedImage sourceImg = ImageIO.read(new FileInputStream(
						imgRealPath));
				String[] imgInfo = new String[3];
				imgInfo[0] = imgRealPath;// 图片路径
				imgInfo[1] = sourceImg.getWidth() + "";// 图片宽度
				imgInfo[2] = (sourceImg.getHeight() + 50) + "";// 图片高度
				getResponse().getWriter().write(
						imgInfo[0] + "|" + imgInfo[1] + "|" + imgInfo[2]);
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

	/**
	 * 查询所有未上线的子商户
	 * 
	 * @return
	 */
	public void selectSubMerchantNoOnline() {
		try {
			if (subMerInfo == null) {
				subMerInfo = new SubMerInfo();
			}
			subMerInfo.setStatus("1");
			Map map = PageUtil.getPageMap(page, pageSize);
			map.put("subMerInfo", subMerInfo);
			List<SubMerInfo> subMerInfoList = subMerInfoDao
					.selectSubMerchantNoOnline(map);
			int count = subMerInfoDao.selectSubMerchantNoOnlineCount(map);
			JSONArray array = JSONArray.fromObject(subMerInfoList);
			JSONObject object = new JSONObject();
			object.put("Rows", array.toString());
			object.put("Total", count);
			subMerList = object.toString();
			getResponse().getWriter().write(subMerList);
		} catch (IOException e) {
			e.printStackTrace();
		}
		System.out.println(subMerList);
	}

	public boolean getFileSize() {
		boolean flag = false;
		int size = 0;
		for (File uploadFile : file) {
			if (uploadFile != null) {
				try {
					size += new FileInputStream(uploadFile).available();
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		}
		if (size <= 4194304) {
			flag = true;
		}
		return flag;
	}

	// 图片上传
	public String uploadImgs() {
		try {
			System.out.println("123");
			String subMerId = this.getId();
			if (subMerId != null) {
				if (!getFileSize()) {
					id = "3";
					return "uploadYes";
				}
				Map<String, String> map = new HashMap<String, String>();
				map.put("regNo", "regNo");// 营业执照
				map.put("taxNo", "taxNo");// 税务登记证
				map.put("occNo", "occNo");// 组织机构代码证
				map.put("idCard", "idCard");// 身份证照片
				map.put("person", "person");// 个人大头照
				map.put("bankPermit", "bankPermit");// 银行开户许可证
				map.put("headImg", "headImg");// 门头照
				map.put("hall", "hall");// 大厅照
				map.put("other1", "other1");// 其他1
				map.put("other2", "other2");// 其他2
				map.put("card", "card");// 银行卡
				// String currentId = new SimpleDateFormat("yyyyMMddHHmmss")
				// .format(new Date());
				// 查询机构号 开始
				subMerInfo = new SubMerInfo();
				subMerInfo.setSubMerId(id);
				subMerInfo = subMerInfoDao.findById(subMerInfo);
				if (subMerInfo != null) {// 确定查询到机构号，修改路径
					subMerId = "/SubMerImages/" + subMerInfo.getMerSysId()
							+ "/" + id;
				}
				id = "2";// 标记！页面提示 查询机构号结束
				// 设置上传文件目录
				String uploadPath = rb.getString("ImagesUrl") + subMerId;
				// 判断文件夹是否在，不存在就创建
				File uploadfile = new File(uploadPath);
				if (!uploadfile.exists() && !uploadfile.isDirectory()) {
					// 不存在
					uploadfile.mkdirs();
				}
				boolean d = true; // 存储删除文件的结果
				String mapKey = ""; // 存储map的键
				// 批量读取图片文件
				if (file != null && file.size() > 0) {
					for (int i = 0; i < file.size(); i++) {
						String imgName = fileFileName.get(i);
						if (regNoImgFile.endsWith(imgName)) {
							mapKey = "regNo";
						} else if (taxNoImgFile.endsWith(imgName)) {
							mapKey = "taxNo";
						} else if (occNoImgFile.endsWith(imgName)) {
							mapKey = "occNo";
						} else if (idCardImgFile.endsWith(imgName)) {
							mapKey = "idCard";
						} else if (personImgFile.endsWith(imgName)) {
							mapKey = "person";
						} else if (bankPermitImgFile.endsWith(imgName)) {
							mapKey = "bankPermit";
						} else if (headImgFile.endsWith(imgName)) {
							mapKey = "headImg";
						} else if (hallImgFile.endsWith(imgName)) {
							mapKey = "hall";
						} else if (otherImgFile1.endsWith(imgName)) {
							mapKey = "other1";
						} else if (otherImgFile2.endsWith(imgName)) {
							mapKey = "other2";
						} else if (cardImgFile.endsWith(imgName)) {
							mapKey = "card";
						}
						// 拼接：文件名+格式
						String uploadName = map.get(mapKey) + ".jpg";
						System.out.println("文件名：" + uploadName);
						// //定义图片的格式
						// String []
						// imgType={".jpg",".png","bmp","tiff","gif","pcx",
						// "tga","exif","fpx","svg","psd","cdr",
						// "pcd","dxf","ufo","eps","ai","raw"};
						// //每种不同格式但同名的图片都进行删除操作
						// for (int j2 = 0; j2 < imgType.length; j2++) {
						// File fileOne=new File(uploadPath+
						// "/"+map.get(mapKey)+imgType[j2]);
						// if(fileOne.exists()){
						// System.out.println("删除文件");
						// d = fileOne.delete();
						// }
						// }
						if (d) {// 进行上传操作
							ys(uploadPath, uploadName, file.get(i));
						} else {
							this.id = "1";
						}
					}
				}
			}
		} catch (Exception e) {
			this.id = "1";
			e.printStackTrace();
		}
		return "uploadYes";
	}

	public void ys(String uploadPath, String uploadName, File file)
			throws IOException {
		String fileName = uploadPath + "/" + uploadName;
		// 获取图片信息。
		BufferedImage sourceImg = ImageIO.read(new FileInputStream(file));
		int width = sourceImg.getWidth(); // 页面显示图片宽度
		int height = sourceImg.getHeight();
		Double px = 1D;
		// 页面显示图片高度
		// 如果是查看所有图片则缩小图片分辨率
		if (width > 400 || height > 300) {
			Double widthPx = Double.parseDouble(width + "") / 400;
			Double heightPx = Double.parseDouble(height + "") / 300;
			if (heightPx > widthPx) {
				px = heightPx;
			} else {
				px = widthPx;
			}
		}
		Image imageIO = ImageIO.read(file);
		int w = Integer.parseInt((width / px + "").substring(0,
				(width / px + "").indexOf(".")));
		int h = Integer.parseInt((height / px + "").substring(0,
				(height / px + "").indexOf(".")));
		sourceImg = new BufferedImage(w, h, BufferedImage.TYPE_INT_RGB);
		sourceImg.getGraphics().drawImage(
				imageIO.getScaledInstance(Integer.parseInt((width / px + "")
						.substring(0, (width / px + "").indexOf("."))), Integer
						.parseInt((height / px + "").substring(0,
								(height / px + "").indexOf("."))),
						Image.SCALE_SMOOTH), 0, 0, null);
		ImageIO.write(sourceImg, "jpg", new File(fileName));
	}

	/**
	 * 
	 * @Description: 修改T+0状态
	 * @Auther: ljl
	 * @Date: 2014-9-24 下午3:37:39
	 */
	public void changet0Status() {
		if (subMerTrans == null) {
			subMerTrans = new SubMerTrans();
		}
		Integer flag = subMerTransDao.updateSubMerTransInfo(subMerTrans);
		try {
			if (flag > 0) {
				this.renderText("true");
			} else {
				this.renderText("false");
			}
		} catch (IOException e) {
			e.printStackTrace();
		}

	}

	// ////////////////////////////////GET
	// SET//////////////////////////////////////////////////

	public SubMerInfoDao getSubMerInfoDao() {
		return subMerInfoDao;
	}

	public String getRateStatus() {
		return rateStatus;
	}

	public void setRateStatus(String rateStatus) {
		this.rateStatus = rateStatus;
	}

	public String getTransHighestFee() {
		return transHighestFee;
	}

	public void setTransHighestFee(String transHighestFee) {
		this.transHighestFee = transHighestFee;
	}

	public List<SubMerTerminal> getListSubMerTerminal() {
		return listSubMerTerminal;
	}

	public void setListSubMerTerminal(List<SubMerTerminal> listSubMerTerminal) {
		this.listSubMerTerminal = listSubMerTerminal;
	}

	public SubMerTerminalDao getSubMerTerminalDao() {
		return subMerTerminalDao;
	}

	public void setSubMerTerminalDao(SubMerTerminalDao subMerTerminalDao) {
		this.subMerTerminalDao = subMerTerminalDao;
	}

	public SubMerTerminal getSubMerTerminal() {
		return subMerTerminal;
	}

	public void setSubMerTerminal(SubMerTerminal subMerTerminal) {
		this.subMerTerminal = subMerTerminal;
	}

	public void setSubMerInfoDao(SubMerInfoDao subMerInfoDao) {
		this.subMerInfoDao = subMerInfoDao;
	}

	public Map getParam() {
		return param;
	}

	public void setParam(Map map) {
		this.param = map;
	}

	public List<SubMerInfo> getListSubMerInfo() {
		return listSubMerInfo;
	}

	public void setListSubMerInfo(List<SubMerInfo> listSubMerInfo) {
		this.listSubMerInfo = listSubMerInfo;
	}

	public SubMerInfo getSubMerInfo() {
		return subMerInfo;
	}

	public void setSubMerInfo(SubMerInfo subMerInfo) {
		this.subMerInfo = subMerInfo;
	}

	public String getSubMerList() {
		return subMerList;
	}

	public void setSubMerList(String subMerList) {
		this.subMerList = subMerList;
	}

	public static long getSerialversionuid() {
		return serialVersionUID;
	}

	public String getId() {
		return id;
	}

	public void setId(String id) {
		this.id = id;
	}

	public int getPage() {
		return page;
	}

	public void setPage(int page) {
		this.page = page;
	}

	public int getPageSize() {
		return pageSize;
	}

	public void setPageSize(int pageSize) {
		this.pageSize = pageSize;
	}

	public SubMerTrans getSubMerTrans() {
		return subMerTrans;
	}

	public void setSubMerTrans(SubMerTrans subMerTrans) {
		this.subMerTrans = subMerTrans;
	}

	public ResourceBundle getRb() {
		return rb;
	}

	public void setRb(ResourceBundle rb) {
		this.rb = rb;
	}

	public BankBehalfBranchDao getBankBehalfBranchDao() {
		return bankBehalfBranchDao;
	}

	public void setBankBehalfBranchDao(BankBehalfBranchDao bankBehalfBranchDao) {
		this.bankBehalfBranchDao = bankBehalfBranchDao;
	}

	public List<BankBehalfBranch> getBankBehalfBranchList() {
		return bankBehalfBranchList;
	}

	public void setBankBehalfBranchList(
			List<BankBehalfBranch> bankBehalfBranchList) {
		this.bankBehalfBranchList = bankBehalfBranchList;
	}

	public List getImgUrlList() {
		return imgUrlList;
	}

	public void setImgUrlList(List imgUrlList) {
		this.imgUrlList = imgUrlList;
	}

	public String getImgRealPath() {
		return imgRealPath;
	}

	public void setImgRealPath(String imgRealPath) {
		this.imgRealPath = imgRealPath;
	}

	public MerManagerDao getMerManagerDao() {
		return merManagerDao;
	}

	public void setMerManagerDao(MerManagerDao merManagerDao) {
		this.merManagerDao = merManagerDao;
	}

	public SysManager getSysManager() {
		return sysManager;
	}

	public void setSysManager(SysManager sysManager) {
		this.sysManager = sysManager;
	}

	public SysManagerService getSysManagerService() {
		return sysManagerService;
	}

	public void setSysManagerService(SysManagerService sysManagerService) {
		this.sysManagerService = sysManagerService;
	}

	public SysOpLogDao getSysOpLogDao() {
		return sysOpLogDao;
	}

	public void setSysOpLogDao(SysOpLogDao sysOpLogDao) {
		this.sysOpLogDao = sysOpLogDao;
	}

	public MerInfoUpdateDao getMerInfoUpdateDao() {
		return merInfoUpdateDao;
	}

	public void setMerInfoUpdateDao(MerInfoUpdateDao merInfoUpdateDao) {
		this.merInfoUpdateDao = merInfoUpdateDao;
	}

	public SubMerRateDao getSubMerRateDao() {
		return subMerRateDao;
	}

	public void setSubMerRateDao(SubMerRateDao subMerRateDao) {
		this.subMerRateDao = subMerRateDao;
	}

	public List<SubMerRate> getSubMerRateList() {
		return subMerRateList;
	}

	public void setSubMerRateList(List<SubMerRate> subMerRateList) {
		this.subMerRateList = subMerRateList;
	}

	public SubMerRate getSubMerRate() {
		return subMerRate;
	}

	public void setSubMerRate(SubMerRate subMerRate) {
		this.subMerRate = subMerRate;
	}

	public String getImgType() {
		return imgType;
	}

	public void setImgType(String imgType) {
		this.imgType = imgType;
	}

	public String getRegNoImgFile() {
		return regNoImgFile;
	}

	public void setRegNoImgFile(String regNoImgFile) {
		this.regNoImgFile = regNoImgFile;
	}

	public String getTaxNoImgFile() {
		return taxNoImgFile;
	}

	public void setTaxNoImgFile(String taxNoImgFile) {
		this.taxNoImgFile = taxNoImgFile;
	}

	public String getOccNoImgFile() {
		return occNoImgFile;
	}

	public void setOccNoImgFile(String occNoImgFile) {
		this.occNoImgFile = occNoImgFile;
	}

	public String getIdCardImgFile() {
		return idCardImgFile;
	}

	public void setIdCardImgFile(String idCardImgFile) {
		this.idCardImgFile = idCardImgFile;
	}

	public String getPersonImgFile() {
		return personImgFile;
	}

	public void setPersonImgFile(String personImgFile) {
		this.personImgFile = personImgFile;
	}

	public String getBankPermitImgFile() {
		return bankPermitImgFile;
	}

	public void setBankPermitImgFile(String bankPermitImgFile) {
		this.bankPermitImgFile = bankPermitImgFile;
	}

	public String getHeadImgFile() {
		return headImgFile;
	}

	public void setHeadImgFile(String headImgFile) {
		this.headImgFile = headImgFile;
	}

	public String getHallImgFile() {
		return hallImgFile;
	}

	public void setHallImgFile(String hallImgFile) {
		this.hallImgFile = hallImgFile;
	}

	public String getOtherImgFile1() {
		return otherImgFile1;
	}

	public void setOtherImgFile1(String otherImgFile1) {
		this.otherImgFile1 = otherImgFile1;
	}

	public String getOtherImgFile2() {
		return otherImgFile2;
	}

	public void setOtherImgFile2(String otherImgFile2) {
		this.otherImgFile2 = otherImgFile2;
	}

	public List<File> getFile() {
		return file;
	}

	public void setFile(List<File> file) {
		this.file = file;
	}

	public List<String> getFileFileName() {
		return fileFileName;
	}

	public void setFileFileName(List<String> fileFileName) {
		this.fileFileName = fileFileName;
	}

	public List<String> getFileContentType() {
		return fileContentType;
	}

	public void setFileContentType(List<String> fileContentType) {
		this.fileContentType = fileContentType;
	}

	public MccCodeDao getMccCodeDao() {
		return mccCodeDao;
	}

	public void setMccCodeDao(MccCodeDao mccCodeDao) {
		this.mccCodeDao = mccCodeDao;
	}

	public List<MccCode> getMccCodeList() {
		return mccCodeList;
	}

	public void setMccCodeList(List<MccCode> mccCodeList) {
		this.mccCodeList = mccCodeList;
	}

	public RegionCodeDao getRegionCodeDao() {
		return regionCodeDao;
	}

	public void setRegionCodeDao(RegionCodeDao regionCodeDao) {
		this.regionCodeDao = regionCodeDao;
	}

	public List<RegionCode> getRegionCodeList() {
		return regionCodeList;
	}

	public void setRegionCodeList(List<RegionCode> regionCodeList) {
		this.regionCodeList = regionCodeList;
	}

	public MerTransDao getMerTransDao() {
		return merTransDao;
	}

	public void setMerTransDao(MerTransDao merTransDao) {
		this.merTransDao = merTransDao;
	}

	public MerTrans getMerTrans() {
		return merTrans;
	}

	public void setMerTrans(MerTrans merTrans) {
		this.merTrans = merTrans;
	}

	public TractInfoDao getTractInfoDao() {
		return tractInfoDao;
	}

	public void setTractInfoDao(TractInfoDao tractInfoDao) {
		this.tractInfoDao = tractInfoDao;
	}

	public List<TractInfo> getTractInfoList() {
		return tractInfoList;
	}

	public void setTractInfoList(List<TractInfo> tractInfoList) {
		this.tractInfoList = tractInfoList;
	}

	public SubMerAuthInfoDao getSubMerAuthInfoDao() {
		return subMerAuthInfoDao;
	}

	public void setSubMerAuthInfoDao(SubMerAuthInfoDao subMerAuthInfoDao) {
		this.subMerAuthInfoDao = subMerAuthInfoDao;
	}

	public SubMerTransDao getSubMerTransDao() {
		return subMerTransDao;
	}

	public void setSubMerTransDao(SubMerTransDao subMerTransDao) {
		this.subMerTransDao = subMerTransDao;
	}

	public MerTractDao getMerTractDao() {
		return merTractDao;
	}

	public void setMerTractDao(MerTractDao merTractDao) {
		this.merTractDao = merTractDao;
	}

	public List<MerTract> getMerTractList() {
		return merTractList;
	}

	public void setMerTractList(List<MerTract> merTractList) {
		this.merTractList = merTractList;
	}

	public String getCardImgFile() {
		return cardImgFile;
	}

	public void setCardImgFile(String cardImgFile) {
		this.cardImgFile = cardImgFile;
	}

	public OrderInfoDao getOrderInfoDao() {
		return orderInfoDao;
	}

	public void setOrderInfoDao(OrderInfoDao orderInfoDao) {
		this.orderInfoDao = orderInfoDao;
	}

	public OrderStatictisDao getOrderStatictisDao() {
		return orderStatictisDao;
	}

	public void setOrderStatictisDao(OrderStatictisDao orderStatictisDao) {
		this.orderStatictisDao = orderStatictisDao;
	}

	public ProcedureDao getProcedureDao() {
		return procedureDao;
	}

	public void setProcedureDao(ProcedureDao procedureDao) {
		this.procedureDao = procedureDao;
	}

	public SubMerTerminalInfoDao getSubMerTerminalInfoDao() {
		return subMerTerminalInfoDao;
	}

	public void setSubMerTerminalInfoDao(
			SubMerTerminalInfoDao subMerTerminalInfoDao) {
		this.subMerTerminalInfoDao = subMerTerminalInfoDao;
	}

	public RegionCodeService getRegionCodeService() {
		return regionCodeService;
	}

	public void setRegionCodeService(RegionCodeService regionCodeService) {
		this.regionCodeService = regionCodeService;
	}

	public RegionCode getRegionCode() {
		return regionCode;
	}

	public void setRegionCode(RegionCode regionCode) {
		this.regionCode = regionCode;
	}
}
